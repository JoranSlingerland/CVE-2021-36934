#Requires -RunAsAdministrator

#change permissions and delete shadows
$checkPermissions = icacls c:\Windows\System32\config\sam
if ($checkPermissions -like '*BUILTIN\Users:(I)(RX*)*' -or $checkPermissions -like '*INGEBOUWD\Gebruikers:(I)(RX*)*') {
    icacls c:\windows\system32\config\*.* /inheritance:e
    vssadmin delete shadows /quiet /all
    $vulnerable = $true
}
else {
    $vulnerable = $false
}

#check permissions
if ($vulnerable -eq $true) {
    $checkPermissions = icacls C:\windows\system32\config\sam
    if ($checkPermissions -like '*BUILTIN\Users:(I)(RX*)*' -or $checkPermissions -like '*INGEBOUWD\Gebruikers:(I)(RX*)*') {
        $permissionsSucces = $false
    }
    else {
        $permissionsSucces = $true
    }
}

#check shadow
if ($vulnerable -eq $true) {
    $checkShadow = Get-CimInstance Win32_ShadowStorage -Property Volume
    if ($null -eq $checkShadow) {
        $shadowSucces = $true
    }
    else {
        $shadowSucces = $false
    }
}

#check if fixed logic
if ($vulnerable -eq $true) {
    if ($permissionsSucces -eq $true -and $shadowSucces -eq $true) {
        $fixed = $true
    }
    else {
        $fixed = $false
    }
}
else {
    $fixed = 'Not applicable'
}

#create new shadow
if ($vulnerable -eq $true -and $shadowSucces -eq $true -and $permissionsSucces -eq $true) {
    Invoke-CimMethod -MethodName Create -ClassName Win32_ShadowCopy -Arguments @{ Volume= "C:\\" }
}

#output data
write-host "vulnerable: $vulnerable"
write-host "Fixed: $fixed"
